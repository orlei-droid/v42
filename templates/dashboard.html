{% extends 'base.html' %}
{% block content %}

<!-- Gamification Header -->
<section
  style="margin-bottom: 3rem; background: rgba(255,255,255,0.02); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05);">
  <div style="display: flex; justify-content: space-between; align-items: end; margin-bottom: 0.8rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <span class="level-badge">LVL {{ perfil.nivel }}</span>
      <div style="display: flex; flex-direction: column;">
        <span style="font-weight: 800; font-size: 1.1rem; color: white;">Mestre da Produtividade</span>
        <span style="color: #a1a1aa; font-size: 0.85rem; font-weight: 600;">{{ perfil.xp }} / {{ perfil.xp_proximo_nivel
          }} XP</span>
      </div>
    </div>
    <div class="coins-display" style="font-size: 1.2rem;">
      <span>ü™ô</span> {{ perfil.moedas }} <span style="font-size: 0.8rem; opacity: 0.7; margin-left: 5px;">V42
        COINS</span>
    </div>
  </div>

  <div class="xp-bar-container">
    <div class="xp-bar-fill" style="width: {{ (perfil.xp / perfil.xp_proximo_nivel) * 100 }}%;"></div>
  </div>
</section>

<!-- Metrics Cards -->
<section class="card-group">
  <div class="card">
    <h3>Total de Miss√µes</h3>
    <div class="metric-value" style="color: var(--primary);">{{ total }}</div>
  </div>
  <div class="card">
    <h3>Conclu√≠das</h3>
    <div class="metric-value" style="color: var(--accent);">{{ concluidas }}</div>
  </div>
  <div class="card">
    <h3>Em Aberto</h3>
    <div class="metric-value" style="color: var(--danger);">{{ abertas }}</div>
  </div>
  <div class="card">
    <h3>Efici√™ncia</h3>
    <div class="metric-value">{{ percentual }}%</div>
  </div>
</section>

<!-- Action Area -->
<section style="margin-top: 2rem;">
  <form method="post" class="mission-form">
    <div style="display: flex; gap: 0.5rem; align-items: center; width: 100%;">
      <select name="tag_nome" id="tag_select"
        style="max-width: 150px; padding: 0.8rem; background: var(--bg-card); color: var(--fg); border: 1px solid var(--primary); border-radius: 8px;">
        <option value="">Sem Tag</option>
        {% if perfil.tags %}
        {% for tag in perfil.tags %}
        <option value="{{ tag.nome }}" data-cor="{{ tag.cor }}">{{ tag.nome }}</option>
        {% endfor %}
        {% endif %}
      </select>
      <!-- Hidden input to store selected color -->
      <input type="hidden" name="tag_cor" id="tag_cor_input">

      <button type="button" class="btn-small" onclick="document.getElementById('modal-tag').style.display='flex'"
        style="background: var(--bg-card); border: 1px solid var(--primary); color: var(--primary); padding: 0.8rem;">+</button>

      <a href="{{ url_for('configuracoes') }}" class="btn-small"
        style="background: var(--bg-card); border: 1px solid var(--primary); color: var(--primary); padding: 0.8rem; text-decoration: none; display: inline-block;">‚öôÔ∏è</a>

      <input type="text" name="missao" placeholder="Nova Miss√£o Priorit√°ria..." required autocomplete="off"
        style="flex-grow: 1;">

      <button type="submit" class="btn-small btn-primary">
        <span>+</span> Adicionar
      </button>
    </div>
  </form>

  <!-- Modal Nova Tag -->
  <div id="modal-tag"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="card" style="width: 300px; padding: 2rem; position: relative;">
      <span onclick="document.getElementById('modal-tag').style.display='none'"
        style="position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 1.5rem;">&times;</span>
      <h3>Nova Tag</h3>
      <form action="{{ url_for('nova_tag') }}" method="POST"
        style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
        <input type="text" name="nome_tag" placeholder="Nome da Tag (ex: Trabalho)" required>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <label>Cor:</label>
          <input type="color" name="cor_tag" value="#ff0000"
            style="width: 50px; height: 50px; border: none; cursor: pointer;">
        </div>
        <button type="submit" class="btn-small btn-primary">Criar Tag</button>
      </form>

      <div style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
        <h4 style="color: var(--fg);">Tags Existentes:</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
          {% if perfil.tags %}
          {% for tag in perfil.tags %}
          <div
            style="display: flex; align-items: center; background: #1a1a1a; padding: 4px 8px; border-radius: 4px; border: 1px solid {{ tag.cor }};">
            <span
              style="width: 10px; height: 10px; border-radius: 50%; background: {{ tag.cor }}; margin-right: 5px;"></span>
            <span style="color: white; font-size: 0.8rem; margin-right: 5px;">{{ tag.nome }}</span>
            <a href="{{ url_for('deletar_tag', nome=tag.nome) }}"
              style="color: #ef4444; text-decoration: none; font-weight: bold; margin-left: 5px;">&times;</a>
          </div>
          {% endfor %}
          {% else %}
          <p style="color: #666; font-size: 0.8rem;">Nenhuma tag criada.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    // Script to update hidden color input when tag is selected
    const tagSelect = document.getElementById('tag_select');
    const tagCorInput = document.getElementById('tag_cor_input');

    function updateTagColor() {
      const selectedOption = tagSelect.options[tagSelect.selectedIndex];
      const color = selectedOption.getAttribute('data-cor');
      tagCorInput.value = color || "";
    }

    // Update on change
    tagSelect.addEventListener('change', updateTagColor);

    // Update on page load (in case a tag is pre-selected)
    updateTagColor();
  </script>


  <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0 1.5rem;">
    <h2 style="color: var(--fg); font-size: 1.4rem; margin: 0;">Miss√µes Ativas</h2>
    <button onclick="toggleConcluidas()" class="btn-small"
      style="background: var(--primary); color: var(--bg); box-shadow: 0 0 15px var(--primary); font-weight: 600; padding: 0.6rem 1.2rem;">
      <span id="toggleText">üëÅÔ∏è Ocultar Conclu√≠das</span>
    </button>
  </div>

  <ul class="list">
    {% for m in missoes %}
    <li class="{% if m.status == 'conclu√≠da' %}concluida missao-concluida{% endif %}">
      <span class="mission-title" style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="color: var(--primary); font-weight: bold;">#{{ loop.index }}</span>
        <span style="display: flex; align-items: center; gap: 0.5rem;">
          {% if m.tag %}
          <span
            style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: {{ m.tag.cor }};"
            title="{{ m.tag.nome }}"></span>
          <span style="color: {{ m.tag.cor }}; font-size: 0.85rem; font-weight: 600;">({{ m.tag.nome }})</span>
          {% endif %}
          {{ m.titulo }}
        </span>
      </span>

      <div style="display:flex; gap: 0.5rem;">
        {% if m.status != 'conclu√≠da' %}
        <a href="{{ url_for('registrar_progresso', i=loop.index0) }}" class="btn-action"
          style="background: var(--primary); color: var(--bg); position: relative; box-shadow: 0 0 20px var(--primary); font-weight: 600;"
          {% if m.registros
          %}title="√öltimos registros: {% for r in m.registros[-3:] %}{{ r.data[:16] }}{% if not loop.last %}, {% endif %}{% endfor %}"
          {% endif %}>
          ‚úì Registrar
          {% if m.registros %}
          <span
            style="position: absolute; top: -8px; right: -8px; background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; border: 2px solid var(--bg);">{{
            m.registros|length }}</span>
          {% endif %}
        </a>
        <a href="{{ url_for('concluir_missao', i=loop.index0) }}" class="btn-action btn-concluir">Concluir</a>
        {% else %}
        <span style="color: var(--accent); font-weight: bold; padding: 0.5rem;">‚úî Completa</span>
        {% endif %}

        <a href="{{ url_for('editar_missao', i=loop.index0) }}" class="btn-action btn-editar">Editar</a>
        <a href="{{ url_for('apagar_missao', i=loop.index0) }}" class="btn-action btn-excluir">Excluir</a>
      </div>
    </li>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: #555;">
      <p>Nenhuma miss√£o ativa. Hora de planejar!</p>
    </div>
    {% endfor %}
  </ul>

  <script>
    let concluidasOcultas = false;
    function toggleConcluidas() {
      const concluidas = document.querySelectorAll('.missao-concluida');
      const toggleText = document.getElementById('toggleText');
      concluidasOcultas = !concluidasOcultas;

      concluidas.forEach(missao => {
        missao.style.display = concluidasOcultas ? 'none' : 'flex';
      });

      toggleText.textContent = concluidasOcultas ? 'üëÅÔ∏è Mostrar Conclu√≠das' : 'üëÅÔ∏è Ocultar Conclu√≠das';
    }
  </script>
</section>

{% endblock %}